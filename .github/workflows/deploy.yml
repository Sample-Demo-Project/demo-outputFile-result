name: Build & Deploy Gallery

on:
  push:
    branches: [ "main", "dev" ]
    paths:
      - "uploads/**"
      - "generate_output_gallery.py"
      - ".github/workflows/deploy.yml"
  workflow_dispatch: {}

# === å¡«é€™è£¡ï¼šDEV ç«™é»ç›®æ¨™ ===
env:
  DEV_REPO_OWNER: Sample-Demo-Project     # ä¾‹ï¼šhowgowin
  DEV_REPO_NAME:  demo-outputFile-result-dev        # ä¾‹ï¼šgallery-dev
  # å¦‚æœ dev repo æœ‰è‡ªè¨‚ç¶²åŸŸï¼ˆCNAMEï¼‰ï¼Œå¯ä»¥æ”¹æˆé‚£å€‹ç¶²åŸŸï¼›å¦å‰‡æœƒè‡ªå‹•ç”¨ GitHub é è¨­ç¶²å€
  DEV_CUSTOM_DOMAIN: ""                 # ä¾‹ï¼šdev.example.comï¼ˆç•™ç©ºå°±ç”¨é è¨­ï¼‰

permissions:
  contents: write       # éœ€è¦æ¨é€åˆ° dev repo
  pages: write          # main åˆ†æ”¯ä½¿ç”¨ GitHub Pages
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build gallery (no deps)
        run: |
          python generate_output_gallery.py
          # ç¢ºä¿ä¸€å®šæœ‰é¦–é ï¼ˆé¿å…éƒ¨ç½²æˆåŠŸå» 404ï¼‰
          test -f docs/index.html || echo "<!doctype html><meta charset='utf-8'><body><h1>No content</h1></body>" > docs/index.html

      # ä¾› main çš„ GitHub Pages artifact
      - name: Upload artifact for Pages (docs/)
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      # ä¾› dev åˆ†æ”¯éƒ¨ç½²åˆ°å¦ä¸€å€‹ repo ä½¿ç”¨ï¼ˆå…ˆå­˜æˆä¸€èˆ¬ artifactï¼‰
      - name: Upload build as generic artifact
        if: github.ref == 'refs/heads/dev'
        uses: actions/upload-artifact@v4
        with:
          name: site-docs
          path: docs

  # --- main åˆ†æ”¯ï¼šéƒ¨ç½²åˆ°æœ¬ repo çš„ GitHub Pages ---
  deploy_main:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Deploy to GitHub Pages (this repo)
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Show deployed URL (in logs & summary)
        run: |
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo "### ğŸŒ GitHub Pages URL" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY

  # --- dev åˆ†æ”¯ï¼šéƒ¨ç½²åˆ°å¦ä¸€å€‹ dev repo çš„ gh-pages ---
  deploy_dev:
    if: github.ref == 'refs/heads/dev'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download built docs
        uses: actions/download-artifact@v4
        with:
          name: site-docs
          path: site-docs

      # éƒ¨ç½²åˆ°ç›®æ¨™ DEV repo çš„ gh-pages
      - name: Deploy to DEV repo gh-pages
        id: dev_deploy
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          repository-name: ${{ env.DEV_REPO_OWNER }}/${{ env.DEV_REPO_NAME }}
          branch: gh-pages
          folder: site-docs
          clean: true
          single-commit: true
          token: ${{ secrets.DEV_PAGES_TOKEN }}

      # é¡¯ç¤º DEV ç«™ç¶²å€ï¼ˆæ”¯æ´è‡ªè¨‚ç¶²åŸŸæˆ–é è¨­ GitHub Pages ç¶²å€ï¼‰
      - name: Show DEV site URL (in logs & summary)
        env:
          DEV_REPO_OWNER: ${{ env.DEV_REPO_OWNER }}
          DEV_REPO_NAME:  ${{ env.DEV_REPO_NAME }}
          DEV_CUSTOM_DOMAIN: ${{ env.DEV_CUSTOM_DOMAIN }}
        run: |
          if [ -n "$DEV_CUSTOM_DOMAIN" ]; then
            DEV_URL="https://${DEV_CUSTOM_DOMAIN}/"
          else
            DEV_URL="https://${DEV_REPO_OWNER}.github.io/${DEV_REPO_NAME}/"
          fi
          echo "URL: ${DEV_URL}"
          echo "### ğŸš§ DEV Preview URL" >> $GITHUB_STEP_SUMMARY
          echo "${DEV_URL}" >> $GITHUB_STEP_SUMMARY
